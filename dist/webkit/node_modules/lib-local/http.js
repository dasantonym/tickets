module.exports = function () {
    var http = require('http'),
        db = require('./db'),
        connect = require('connect'),
        cors = require('cors'),
        async = require('async'),
        bodyParser = require('body-parser'),
        app = connect();
    app.use(cors());
    app.use(bodyParser.json());
    app.use(function (req, res) {
        var querySplit = req.url.split('?');
        var baseurl = querySplit[0];
        var ticketKey = null;
        if (querySplit.length > 1) {
            ticketKey = querySplit[1];
        }
        switch (baseurl) {
            case '/api/v1/electronic_tickets.json':
                db.find({}, function (err, tickets) {
                    res.contentType = 'application/json';
                    if (err) {
                        res.statusCode = 400;
                        res.end(JSON.stringify(err));
                    } else {
                        res.end(JSON.stringify(tickets));
                    }
                });
                break;
            case '/api/v1/ticket_void.json':
                console.log(ticketKey);
                async.waterfall([
                    function (cb) {
                        db.findOne({ ticket_key: ticketKey }, cb);
                    },
                    function (ticket, cb) {
                        if (ticket) {
                            if (ticket.isVoid) {
                                cb(new Error('ticket already claimed'), null);
                            } else {
                                ticket.isVoid = true;
                                db.update(ticket, ticketKey, function (err) {
                                    cb(err, ticket);
                                });
                            }
                        } else {
                            cb(new Error('ticket not found'), null);
                        }
                    }
                ], function (err, ticket) {
                    if (err) {
                        res.end(JSON.stringify({ error: err.message }));
                    } else {
                        res.end(JSON.stringify({ success: true, ticket: ticket }));
                    }
                });
                break;
            default:
                res.end();
                break;
        }
    });
    http.createServer(app).listen(9999);
};