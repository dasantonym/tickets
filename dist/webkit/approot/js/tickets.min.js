/*! tickets webkit - v0.2.0 - 2017-06-26 */

angular.module("tickets.directives.ioloader",[]).directive("ioLoader",["App.Socket","PubSub",function(a,b){function c(a){var b=document.getElementById("socketScript"),c=document.createElement("script");c.setAttribute("id","socketScript"),c.setAttribute("type","text/javascript"),c.setAttribute("src",a),b&&c.src!==b.src?(document.getElementsByTagName("head")[0].removeChild(b),document.getElementsByTagName("head")[0].appendChild(c)):c&&!b&&document.getElementsByTagName("head")[0].appendChild(c)}function d(c){window.setTimeout(function(){if("function"==typeof io&&"string"==typeof c){var e=io("http://"+c+":7777");a.setSocket(e),a.setSocketCallback(function(a){console.log("Socket.io void callback with token:",a),b.publish("void-update",a)}),console.log("Socket.io connected")}else console.log("Socket.io not defined or empty IP, retrying"),window.setTimeout(function(){d(c)},0)},500)}return{restrict:"E",scope:{ipAddress:"@"},link:function(a,b,e){function f(){e.ipAddress&&(c("http://"+e.ipAddress+":7777/socket.io/socket.io.js"),d(e.ipAddress))}e.$observe("ipAddress",function(){f()})}}}]),angular.module("tickets.directives.utils",[]).directive("stringToNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return""+a}),d.$formatters.push(function(a){return parseFloat(a)})}}}),angular.module("tickets.services.socket",[]).factory("App.Socket",function(){return{socket:null,socketCallback:null,setSocket:function(a){var b=this;this.socket=a,this.socket.on("ticket.void",function(a){"function"==typeof b.socketCallback&&b.socketCallback(a)})},setSocketCallback:function(a){"function"==typeof a&&(this.socketCallback=a)},sendTicketVoid:function(a){this.socket&&this.socket.emit("ticket.void",a)}}}),function(){"use strict";angular.module("ticket-server",["ui.bootstrap","ngRoute","cgBusy","PubSub","ngFileUpload","tickets.controllers.tickets","tickets.services.settings","tickets.services.sync","tickets.services.socket","tickets.services.backup","tickets.directives.ioloader","tickets.directives.utils"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0);var d="./partials/";a.eagerInstantiationEnabled(!0),a.when("/list",{templateUrl:d+"tickets_list.html",controller:"Tickets.List"}),a.when("/sync",{templateUrl:d+"sync.html",controller:"Tickets.Sync"}),a.when("/backup",{templateUrl:d+"backup.html",controller:"Tickets.Backup"}),a.otherwise({redirectTo:"/list"})}]).run(["$rootScope","$q","$location","App.Sync",function(a,b,c,d){a.goto=function(a){c.path(a)},a.$on("$routeChangeStart",function(c,d,e){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null),a.pageDefer=b.defer(),a.pagePromise=a.pageDefer.promise}),a.$on("$routeChangeSuccess",function(b,c,d){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null)}),a.$on("$routeChangeError",function(b,c,d){a.pageDefer&&(a.pageDefer.reject(),a.pageDefer=null)}),global.require("lib-local/socket.io").setup(),d.startBackgroundSync()}])}(),function(){"use strict";var a=global.require;angular.module("tickets.controllers.tickets",[]).controller("Tickets.List",["$scope","$q","PubSub",function(b,c,d){function e(){g(function(){setTimeout(e,5e3)})}var f=a("lib-local/db.js");b.tickets=[],b.filter={query:void 0},b.$watch("filter.query",function(a){async.each(b.tickets,function(c,d){[c.firstname?c.firstname.toLowerCase():"",c.lastname?c.lastname.toLowerCase():"",c.order_number?c.order_number.toLowerCase():"",c.email?c.email.toLowerCase():"",c.type?c.type.toLowerCase():"",c.category?c.category.toLowerCase():"",c.token].join(" ").indexOf(a.toLowerCase())<0?b.tickets[b.tickets.indexOf(c)].hideEntry=!0:b.tickets[b.tickets.indexOf(c)].hideEntry=!1,d()})}),b.claimTicket=function(a){window.confirm("Are you sure you are claiming the right ticket "+a.token+" ("+[a.firstname,a.lastname].join(" ")+")?")&&(delete a.$$hashKey,a.void=!0,a.void_at=new Date,f.update(a,a.token,function(a){a&&(b.alerts=[{type:"danger",msg:a.message}]),b.$apply()}))};var g=function(a){f.find({},function(c,d){if(d.sort(function(a,b){return a.lastname<b.lastname?-1:a.lastname>b.lastname?1:0}),c)b.alerts=[{type:"danger",msg:c.message}];else if(0===b.tickets.length)b.tickets=d;else for(var e in d)!b.tickets[e].void&&d[e].void&&(b.tickets[e].void=d[e].void,b.tickets[e].void_at=d[e].void_at);h.resolve(),b.$apply(),"function"==typeof a&&a()})},h=c.defer();b.promiseString="Loading tickets...",b.promise=h.promise,e(),d.subscribe("sync-update",g)}]).controller("Tickets.Sync",["$scope","$q","App.Settings","App.Sync",function(a,b,c,d){a.remote={url:c.remote.url,login:c.remote.login,password:c.remote.password,interval:c.remote.interval||0},a.push={url:c.push.url,backoff:c.push.backoff||0},a.submitSync=function(){var e=b.defer();a.promiseString="Saving...",a.promise=e.promise,c.storeRemote(a.remote.url,a.remote.login,a.remote.password,a.remote.interval),d.startBackgroundSync(),a.alerts=[{type:"success",msg:"Sync settings saved"}],e.resolve()},a.submitPush=function(){var d=b.defer();a.promiseString="Saving...",a.promise=d.promise,c.storePush(a.push.url,a.push.backoff),a.alerts=[{type:"success",msg:"Push settings saved"}],d.resolve()}}]).controller("Tickets.Backup",["$scope","$q","App.Settings","App.Backup","Upload",function(b,c,d,e,f){b.backup={backupInterval:d.backup.backupInterval||0,autoBackupPath:d.backup.autoBackupPath,backupPath:void 0,restorePath:void 0},b.submitSettings=function(){var a=c.defer();b.promiseString="Saving...",b.promise=a.promise,d.storeBackup(b.backup.backupInterval,b.backup.autoBackupPath),b.alerts=[{type:"success",msg:"Backup settings saved"}],a.resolve()},b.submitCreate=function(){var a=c.defer();b.promiseString="Backing up...",b.promise=a.promise,b.alerts=[{type:"success",msg:"Backup successfully saved"}],a.resolve()},b.submitRestore=function(){var d=c.defer();return b.promiseString="Restoring backup...",b.promise=d.promise,a("fs-extra").readdir(b.backup.restorePath).then(function(a){}).then(function(){b.alerts=[{type:"success",msg:"Backup successfully restored"}],d.resolve()}).catch(function(a){b.alerts=[{type:"error",msg:"Backup restore failed: "+a.message}],d.reject(a)})}}])}(),angular.module("tickets.services.backup",[]).factory("App.Backup",["App.Settings","$http","PubSub",function(a){var b=global.require;b("fs"),b("path"),b("nw.gui");return{save:function(){},restore:function(){}}}]),angular.module("tickets.services.settings",[]).factory("App.Settings",function(){return{remote:{url:localStorage["remote.url"],login:localStorage["remote.login"],password:localStorage["remote.password"],interval:localStorage["remote.interval"]},push:{url:localStorage["push.url"],backoff:localStorage["push.backoff"]||0},stats:{last_sync:localStorage["stats.last_sync"],last_push:localStorage["stats.last_push"]},backup:{backupInterval:localStorage["backup.backupInterval"],autoBackupPath:localStorage["backup.autoBackupPath"]},storeRemote:function(a,b,c,d){this.remote.url=a,this.remote.login=b,this.remote.password=c,this.remote.interval=d,localStorage["remote.url"]=this.remote.url,localStorage["remote.login"]=this.remote.login,localStorage["remote.password"]=this.remote.password,localStorage["remote.interval"]=this.remote.interval},storePush:function(a,b){this.push.url=a,this.push.backoff=b,localStorage["push.url"]=this.push.url,localStorage["push.backoff"]=this.push.backoff},storeBackup:function(a,b){this.backup.backupInterval=a,this.backup.autoBackupPath=b,localStorage["backup.backupInterval"]=this.backup.backupInterval,localStorage["backup.autoBackupPath"]=this.backup.autoBackupPath}}}),angular.module("tickets.services.sync",[]).factory("App.Sync",["App.Settings","$http","PubSub",function(a,b,c){return{autoTimeout:null,pushTimeout:null,startBackgroundSync:function(){function b(){c.syncRemote(function(){c.autoTimeout=setTimeout(b,6e4*a.remote.interval)})}if(this.autoTimeout&&clearTimeout(this.autoTimeout),a.remote.interval){var c=this;b()}},startBackgroundPush:function(){function b(){c.pushPending(function(){c.pushTimeout=setTimeout(b,1e3*a.push.backoff)})}if(this.pushTimeout&&clearTimeout(this.pushTimeout),a.push.url){var c=this;b()}},syncRemote:function(d){var e=require("lib-local/db.js");if(!a.remote.url||!a.remote.login||!a.remote.password)return d();var f=!1;async.waterfall([function(c){b({url:a.remote.url+"/api/access_tokens.json",method:"POST",data:{email:a.remote.login,password:a.remote.password}}).then(function(a){c(null,a)},function(a){c(null,a)})},function(a,b){200===a.status?b(null,a.data.token):403===a.status?b(new Error("Access Denied"),null):b(new Error("Unknown error: HTTP status "+a.status),null)},function(c,d){b({url:a.remote.url+"/api/data/dump/tickets.json",method:"GET",headers:{"X-Authentication":c}}).then(function(a){d(null,a)},function(a){d(null,a)})},function(a,b){200===a.status?b(null,a.data):403===a.status?b(new Error("Access Denied"),null):b(new Error("Unknown error: HTTP status "+a.status),null)},function(b,c){async.each(b,function(b,c){async.waterfall([function(a){e.findOne({token:b.token},a)},function(a,c){a?c(null,a):(f=!0,e.create(b,c))}],function(d){if(d)return c(d);a.push.url&&sync.addPendingUpdate(b.uuid,b,c)})},function(a){c(a)})}],function(a){if(a)return console.log("Sync failed with error: "+a.message),d(a);f&&(console.log("Sync completed - updating"),c.publish("sync-update")),d()})},pushLocal:function(a,b,c){require("lib-local/sync.js").addPendingUpdate(a,b,c)},pushPending:function(c){var d=require("lib-local/sync.js");async.waterfall([function(a){d.pendingUpdates(a)},function(c,e){async.eachSeries(c,function(c,e){async.waterfall([function(e){b({method:"POST",url:a.push.url+"/api/tickets/push.json",data:c}).then(function(a){200===a.status?d.remove(c,c._id,e):400===a.status&&(console.log("Push update outdated"),d.remove(c,c._id,e))},function(a){400===a.status?(console.log("Push update outdated"),d.remove(c,c._id,e)):(console.log("Push update failed for ticket UUID "+c.ticket_uuid),e())})}],e)},e)}],function(a){if(a)return console.log("Push failed with error: "+a.message),c(a);c()})}}}]);