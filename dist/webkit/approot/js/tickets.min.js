/*! tickets webkit - v0.1.0 - 2017-06-20 */

!function(){"use strict";angular.module("ticket-server",["ui.bootstrap","ngRoute","cgBusy","tickets.controllers.tickets"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0);var d="partials/";a.when("/",{templateUrl:d+"tickets_list.html",controller:"Tickets.List"}),a.when("/sync",{templateUrl:d+"sync.html",controller:"Tickets.Sync"}),a.otherwise({redirectTo:"/"})}]).run(["$rootScope","$q",function(a,b){}])}(),function(){"use strict";var a=global.require;angular.module("tickets.controllers.tickets",[]).controller("Tickets.List",["$scope","$q","$routeParams",function(b,c,d){var e=a("lib-local/db.js"),f=c.defer();b.promiseString="Loading tickets...",b.promise=f.promise,b.tickets=[],b.filter={query:null},b.$watch("filter.query",function(a){async.each(b.tickets,function(c,d){[c.firstname.toLowerCase,c.lastname.toLowerCase(),c.email.toLowerCase(),c.ticket_key].join(" ").indexOf(a.toLowerCase())<0?b.tickets[b.tickets.indexOf(c)].hideEntry=!0:b.tickets[b.tickets.indexOf(c)].hideEntry=!1,d()})}),b.claimTicket=function(a){window.confirm("Are you sure you are claiming the right ticket #"+a.ticket_key+" ("+[a.firstname,a.lastname].join(" ")+")?")&&(delete a.$$hashKey,console.log(a),a.isVoid=!0,e.update(a,a.ticket_key,function(a){a&&(console.log(a),b.alerts=[{type:"danger",msg:a.message}]),b.$apply()}))};var g=function(){e.find({},function(a,c){if(c.sort(function(a,b){return a.lastname<b.lastname?-1:a.lastname>b.lastname?1:0}),a)b.alerts=[{type:"danger",msg:a.message}];else if(0===b.tickets.length)b.tickets=c;else for(var d in c)!b.tickets[d].isVoid&&c[d].isVoid&&(b.tickets[d].isVoid=c[d].isVoid);f.resolve(),b.$apply(),window.setTimeout(function(){g()},2e3)})};g()}]).controller("Tickets.Sync",["$scope","$q","$routeParams",function(b,c,d){b.remote={url:"",login:"",password:""},b.submit=function(){var d=c.defer(),e=a("lib-local/db.js"),f=a("request"),g=b.remote.url.split("://");b.promiseString="Syncing...",b.promise=d.promise,b.remote.login&&b.remote.password&&2===g.length&&(g[1]=b.remote.login+":"+b.remote.password+"@"+g[1]),async.waterfall([function(a){f(g.join("://"),a)},function(a,b,c){if(200==a.statusCode)try{var d=JSON.parse(b);c(null,d)}catch(a){c(new Error("Corrupted response data"),null)}else 403==a.statusCode?c(new Error("Access Denied"),null):c(new Error("Unknown error: HTTP status "+a.statusCode),null)},function(a,b){async.each(a,function(a,b){async.waterfall([function(b){e.findOne({ticket_key:a.ticket_key},b)},function(b,c){b?c(null,b):e.create(a,c)}],function(a){b(a)})},function(a){b(a)})}],function(a){if(a)return console.log(a),b.alerts=[{type:"danger",msg:a.message}],void d.reject();b.alerts=[{type:"success",msg:"Sync completed"}],d.resolve(),b.$apply()})}}])}();