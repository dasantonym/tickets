/*! NondescriptTicketSoftware webkit - v0.2.0 - 2017-06-28 */

angular.module("tickets.directives.ioloader",[]).directive("ioLoader",["App.Socket","PubSub",function(a,b){function c(a){var b=document.getElementById("socketScript"),c=document.createElement("script");c.setAttribute("id","socketScript"),c.setAttribute("type","text/javascript"),c.setAttribute("src",a),b&&c&&c.src!==b.src?(document.getElementsByTagName("head")[0].removeChild(b),document.getElementsByTagName("head")[0].appendChild(c)):c&&!b&&document.getElementsByTagName("head")[0].appendChild(c)}function d(c){window.setTimeout(function(){if("function"==typeof io&&"string"==typeof c){var e=io("http://"+c+":7777");a.setSocket(e),a.setSocketCallback(function(a){console.log("Socket.io void callback with token:",a),b.publish("void-update",a)}),console.log("Socket.io connected")}else console.log("Socket.io not defined or empty IP, retrying"),window.setTimeout(function(){d(c)},100)},500)}return{restrict:"E",scope:{ipAddress:"@"},link:function(a,b,e){function f(){e.ipAddress&&(c("http://"+e.ipAddress+":7777/socket.io/socket.io.js"),d(e.ipAddress))}e.$observe("ipAddress",function(){f()})}}}]),angular.module("tickets.directives.utils",[]).directive("stringToNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return""+a}),d.$formatters.push(function(a){return parseFloat(a)})}}}),angular.module("tickets.services.heartbeat",[]).factory("App.Heartbeat",["$http",function(a){return{target:null,interval:2e3,timeout:null,status:null,setup:function(a,b){this.target=a,this.interval=b||2e3},start:function(){function b(){a.get(c.target).then(function(a){c.status=200===a.status,c.timeout=setTimeout(b,c.interval)},function(){c.status=!1,c.timeout=setTimeout(b,c.interval)})}if("string"==typeof this.target){this.stop();var c=this;b()}},stop:function(){this.timeout&&clearTimeout(this.timeout)}}}]),angular.module("tickets.services.socket",[]).factory("App.Socket",function(){return{socket:null,socketCallback:null,setSocket:function(a){var b=this;this.socket=a,this.socket.on("ticket.void",function(a){"function"==typeof b.socketCallback&&b.socketCallback(a)})},setSocketCallback:function(a){"function"==typeof a&&(this.socketCallback=a)},sendTicketVoid:function(a){this.socket&&this.socket.emit("ticket.void",a)}}}),function(){"use strict";angular.module("ticket-server",["ui.bootstrap","ngRoute","cgBusy","PubSub","ngFileUpload","tickets.controllers.tickets","tickets.controllers.modalclaim","tickets.services.settings","tickets.services.stats","tickets.services.sync","tickets.services.socket","tickets.services.backup","tickets.directives.stats","tickets.directives.ioloader","tickets.directives.utils"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0);var d="./partials/";a.eagerInstantiationEnabled(!0),a.when("/list",{templateUrl:d+"tickets_list.html",controller:"Tickets.List"}),a.when("/sync",{templateUrl:d+"sync.html",controller:"Tickets.Sync"}),a.when("/backup",{templateUrl:d+"backup.html",controller:"Tickets.Backup"}),a.otherwise({redirectTo:"/list"})}]).run(["$rootScope","$q","$location","App.Sync","App.Backup","App.Settings",function(a,b,c,d,e,f){a.goto=function(a){c.path(a)},a.$on("$routeChangeStart",function(c,d,e){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null),a.pageDefer=b.defer(),a.pagePromise=a.pageDefer.promise}),a.$on("$routeChangeSuccess",function(b,c,d){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null)}),a.$on("$routeChangeError",function(b,c,d){a.pageDefer&&(a.pageDefer.reject(),a.pageDefer=null)}),a.httpServer=global.require("lib-local/http"),a.httpServer.settings=f,a.httpServer.server(),global.require("lib-local/socket.io").setup(),d.startBackgroundSync(),e.startBackgroundAutoBackup()}])}(),angular.module("tickets.controllers.modalclaim",[]).controller("Modal.Claim",function(a,b){var c=this;c.items=b,c.selected={item:c.items[0]},c.ok=function(){a.close(c.selected.item)},c.cancel=function(){a.dismiss("cancel")}}),function(){"use strict";var a=global.require;angular.module("tickets.controllers.tickets",[]).controller("Tickets.List",["$scope","$q","PubSub","App.Stats",function(b,c,d,e){function f(){h(function(){setTimeout(f,1e4)})}var g=a("lib-local/db");b.tickets=[],b.filter={query:void 0},b.$watch("filter.query",function(a){async.each(b.tickets,function(c,d){[c.firstname?c.firstname.toLowerCase():"",c.lastname?c.lastname.toLowerCase():"",c.order_number?c.order_number.toLowerCase():"",c.email?c.email.toLowerCase():"",c.type?c.type.toLowerCase():"",c.category?c.category.toLowerCase():"",c.token].join(" ").indexOf(a.toLowerCase())<0?b.tickets[b.tickets.indexOf(c)].hideEntry=!0:b.tickets[b.tickets.indexOf(c)].hideEntry=!1,d()})}),b.claimTicket=function(a){window.confirm("Are you sure you are claiming the right ticket "+a.token+" ("+[a.firstname,a.lastname].join(" ")+")?")&&(delete a.$$hashKey,a.void=!0,a.void_at=new Date,g.update(a,a.token,function(a){a&&(b.alerts=[{type:"danger",msg:a.message}]),b.$apply()}))};var h=function(a){var c=0,d=0;g.find({},function(f,g){if(g.sort(function(a,b){return a.updated>b.updated?-1:a.updated<b.updated?1:0}),f)b.alerts=[{type:"danger",msg:f.message}];else if(0===b.tickets.length)b.tickets=g;else{var h=[];b.tickets.map(function(a){for(var b=0;b<g.length&&a.uuid!==g[b].uuid;)b+=1;return g[b]?(g[b]&&!a.void&&g[b].void&&(a.void=g[b].void,a.void_at=g[b].void_at),g[b]&&!a.valid&&g[b].valid&&(a.valid=g[b].valid),d+=a.void?1:0,c+=a.valid?1:0,a):void h.push(a.uuid)});for(var j=b.tickets.length-1;j>=0;j-=1)null===b.tickets[j]&&b.tickets.splice(j,1);g.map(function(a){for(var c=0;c<b.tickets.length&&b.tickets[c].uuid!==a.uuid;)c+=1;c===b.tickets.length&&b.tickets.unshift(a)})}e.storeStats(null,null,null,b.tickets.length,null,c,d),i.resolve(),b.$apply(),"function"==typeof a&&a()})},i=c.defer();b.promiseString="Loading tickets...",b.promise=i.promise,f(),d.subscribe("sync-update",h)}]).controller("Tickets.Sync",["$scope","$q","App.Settings","App.Sync",function(a,b,c,d){a.remote={url:c.remote.url,login:c.remote.login,password:c.remote.password,interval:c.remote.interval||0},a.push={url:c.push.url,backoff:c.push.backoff||0},a.submitSync=function(){var e=b.defer();a.promiseString="Saving...",a.promise=e.promise,c.storeRemote(a.remote.url,a.remote.login,a.remote.password,a.remote.interval),d.startBackgroundSync(),a.alerts=[{type:"success",msg:"Sync settings saved"}],e.resolve()},a.submitPush=function(){var d=b.defer();a.promiseString="Saving...",a.promise=d.promise,c.storePush(a.push.url,a.push.backoff),a.alerts=[{type:"success",msg:"Push settings saved"}],d.resolve()}}]).controller("Tickets.Backup",["$scope","$q","App.Settings","App.Backup",function(a,b,c,d){a.backup={backupInterval:c.backup.backupInterval||0,autoBackupPath:c.backup.autoBackupPath,backupPath:void 0,restorePath:void 0},a.onFileSelect=function(b,c){Array.isArray(b)&&0!==b.length&&(console.log(b),a.backup[c]=b[0].path)},a.submitSettings=function(){var e=b.defer();a.promiseString="Saving...",a.promise=e.promise,c.storeBackup(a.backup.backupInterval,a.backup.autoBackupPath),d.startBackgroundAutoBackup(),a.alerts=[{type:"success",msg:"Backup settings saved"}],e.resolve()},a.submitCreate=function(){var c=b.defer();a.promiseString="Backing up...",a.promise=c.promise,d.save(a.backup.backupPath,function(b){if(b)return a.alerts=[{type:"success",msg:"Backup failed: "+b.message}],c.reject(b);a.alerts=[{type:"success",msg:"Backup successfully saved"}],c.resolve()})},a.submitRestore=function(){var c=b.defer();a.promiseString="Restoring backup...",a.promise=c.promise,d.restore(a.backup.restorePath,function(b){if(b)return a.alerts=[{type:"error",msg:"Backup restore failed: "+b.message}],c.reject(b);a.alerts=[{type:"success",msg:"Backup successfully restored"}],c.resolve()})}}])}(),angular.module("tickets.directives.stats",[]).directive("displayStats",["App.Stats","PubSub",function(a,b){return{link:function(c){c.stats=a.stats,b.subscribe("stats-update",function(){c.stats=a.stats})}}}]),angular.module("tickets.services.backup",[]).factory("App.Backup",["App.Settings",function(a){var b=global.require,c=b("fs-extra"),d=b("path"),e=b("lib-local/db"),f=b("lib-local/db-orders"),g=b("lib-local/sync");return{autoBackupTimeout:null,startBackgroundAutoBackup:function(){function b(){for(var e=Date.now().toString();e.length<16;)e="0"+e;c.save(d.join(a.backup.autoBackupPath,"tickets-"+e),function(){c.autoBackupTimeout=setTimeout(b,6e4*a.backup.backupInterval)})}if(this.autoBackupTimeout&&clearTimeout(this.autoBackupTimeout),a.backup.backupInterval&&a.backup.autoBackupPath){var c=this;b()}},save:function(b,h){async.waterfall([function(a){c.ensureDir(b,function(b){a(b)})},function(a){e.find({},function(e,f){if(e)return a(e);c.writeFile(d.join(b,"tickets.json"),JSON.stringify(f),a)})},function(a){f.find({},function(e,f){if(e)return a(e);c.writeFile(d.join(b,"orders.json"),JSON.stringify(f),a)})},function(a){g.pendingUpdates(function(e,f){if(e)return a(e);c.writeFile(d.join(b,"updates.json"),JSON.stringify(f),a)})},function(e){c.writeFile(d.join(b,"settings.json"),JSON.stringify({remote:a.remote,push:a.push,stats:a.stats,backup:a.backup}),e)}],function(a){h(a)})},restore:function(b,h){async.waterfall([function(a){c.stat(b,function(b){a(b)})},function(a){e.empty(a)},function(a){c.readFile(d.join(b,"tickets.json"),a)},function(a,b){var c=JSON.parse(a);async.eachSeries(c,function(a,b){e.create(a,function(a){b(a)})},function(a){b(a)})},function(a){f.empty(a)},function(a){c.readFile(d.join(b,"orders.json"),a)},function(a,b){var c=JSON.parse(a);async.eachSeries(c,function(a,b){f.create(order,function(a){b(a)})},function(a){b(a)})},function(a){g.empty(a)},function(a){c.readFile(d.join(b,"updates.json"),a)},function(a,b){var c=JSON.parse(a);async.eachSeries(c,function(a,b){g.addPendingUpdate(a.ticket_uuid,a.update,function(a){b(a)})},function(a){b(a)})},function(a){c.readFile(d.join(b,"settings.json"),a)},function(b,c){var d=JSON.parse(b);a.storeRemote(d.remote.url,d.remote.login,d.remote.password,d.remote.interval),a.storePush(d.push.url,d.push.interval),a.storeStats(d.stats.last_sync,d.stats.last_push),a.storeBackup(d.backup.backupInterval,d.backup.autoBackupPath),c()}],function(a){h(a)})}}}]),angular.module("tickets.services.settings",[]).factory("App.Settings",function(){return{remote:{url:localStorage["remote.url"],login:localStorage["remote.login"],password:localStorage["remote.password"],interval:localStorage["remote.interval"],latest_update:localStorage["remote.latestUpdate"]},push:{url:localStorage["push.url"],backoff:localStorage["push.backoff"]||0},backup:{backupInterval:localStorage["backup.backupInterval"],autoBackupPath:localStorage["backup.autoBackupPath"]},storeRemote:function(a,b,c,d){this.remote.url=a,this.remote.login=b,this.remote.password=c,this.remote.interval=d,localStorage["remote.url"]=this.remote.url,localStorage["remote.login"]=this.remote.login,localStorage["remote.password"]=this.remote.password,localStorage["remote.interval"]=this.remote.interval},storeRemoteUpdate:function(a){this.remote.latest_update=a,localStorage["remote.latestUpdate"]=this.remote.latest_update},storePush:function(a,b){this.push.url=a,this.push.backoff=b,localStorage["push.url"]=this.push.url,localStorage["push.backoff"]=this.push.backoff},storeBackup:function(a,b){this.backup.backupInterval=a,this.backup.autoBackupPath=b,localStorage["backup.backupInterval"]=this.backup.backupInterval,localStorage["backup.autoBackupPath"]=this.backup.autoBackupPath}}}),angular.module("tickets.services.stats",[]).factory("App.Stats",["PubSub",function(a){return{stats:{last_sync:localStorage["stats.last_sync"]?new Date(localStorage["stats.last_sync"]):void 0,last_push:localStorage["stats.last_push"]?new Date(localStorage["stats.last_push"]):void 0,reachability:localStorage["stats.reachability"]||!1,tickets:localStorage["stats.tickets"]||0,tickets_valid:localStorage["stats.tickets_valid"]||0,tickets_void:localStorage["stats.tickets_void"]||0,pending:localStorage["stats.pending"]||0},storeStats:function(b,c,d,e,f,g,h){var i=!1;b instanceof Date&&this.stats.last_sync!==b&&(i=!0,this.stats.last_sync=b,localStorage["stats.last_sync"]=this.stats.last_sync),c instanceof Date&&this.stats.last_push!==c&&(i=!0,this.stats.last_push=c,localStorage["stats.last_push"]=this.stats.last_push),"boolean"==typeof d&&this.stats.reachability!==d&&(i=!0,this.stats.reachability=d,localStorage["stats.reachability"]=this.stats.reachability),"number"==typeof e&&this.stats.tickets!==e&&(i=!0,this.stats.tickets=e,localStorage["stats.tickets"]=this.stats.tickets),"number"==typeof f&&this.stats.pending!==f&&(i=!0,this.stats.pending=f,localStorage["stats.pending"]=this.stats.pending),"number"==typeof g&&this.stats.tickets_valid!==g&&(i=!0,this.stats.tickets_valid=g,localStorage["stats.tickets_valid"]=this.stats.tickets_valid),"number"==typeof h&&this.stats.tickets_void!==h&&(i=!0,this.stats.tickets_void=h,localStorage["stats.tickets_void"]=this.stats.tickets_void),i&&a.publish("stats-update")}}}]),angular.module("tickets.services.sync",[]).factory("App.Sync",["App.Settings","$http","PubSub","App.Stats",function(a,b,c,d){return{autoTimeout:null,pushTimeout:null,startBackgroundSync:function(){function b(){c.syncRemoteTickets(function(){c.syncRemoteOrders(function(){c.autoTimeout=setTimeout(b,6e4*a.remote.interval)})})}if(this.autoTimeout&&clearTimeout(this.autoTimeout),a.remote.interval){var c=this;b()}},startBackgroundPush:function(){function b(){c.pushPending(function(){c.pushTimeout=setTimeout(b,1e3*a.push.backoff)})}if(this.pushTimeout&&clearTimeout(this.pushTimeout),a.push.url){var c=this;b()}},syncRemoteTickets:function(e){var f=require("lib-local/db");if(!a.remote.url||!a.remote.login||!a.remote.password)return e();var g=!1;async.waterfall([function(c){b({url:a.remote.url+"/api/access_tokens.json",method:"POST",data:{email:a.remote.login,password:a.remote.password}}).then(function(a){d.storeStats(null,null,!0,null,null),c(null,a)},function(a){d.storeStats(null,null,!1,null,null),c(null,a)})},function(a,b){200===a.status?(d.storeStats(null,null,!0,null,null),b(null,a.data.token)):403===a.status?b(new Error("Access Denied"),null):(d.storeStats(null,null,!1,null,null),b(new Error("Unknown error: HTTP status "+a.status),null))},function(c,e){b({url:a.remote.url+"/api/data/dump/tickets.json",method:"GET",headers:{"X-Authentication":c}}).then(function(a){d.storeStats(null,null,!0,null,null),e(null,a)},function(a){d.storeStats(null,null,!1,null,null),e(null,a)})},function(a,b){200===a.status?(d.storeStats(null,null,!0,null,null),b(null,a.data)):403===a.status?b(new Error("Access Denied"),null):(d.storeStats(null,null,!1,null,null),b(new Error("Unknown error: HTTP status "+a.status),null))},function(b,c){async.eachSeries(b,function(b,c){async.waterfall([function(a){f.findOne({token:b.token},a)},function(a,c){a?c(null,a):(g=!0,f.create(b,c))}],function(d){if(d||!a.push.url)return c(d);sync.addPendingUpdate(b.uuid,b,function(a){c(a)})})},function(a){c(a)})}],function(a){if(a)return d.storeStats(null,null,!1,null,null),console.log("Sync failed with error: "+a.message),e(a);d.storeStats(new Date,null,!0,null,null),g&&(console.log("Sync completed - updating"),c.publish("sync-update")),e()})},syncRemoteOrders:function(e){var f=require("lib-local/db-orders");if(!a.remote.url||!a.remote.login||!a.remote.password)return e();var g=!1;async.waterfall([function(c){b({url:a.remote.url+"/api/access_tokens.json",method:"POST",data:{email:a.remote.login,password:a.remote.password}}).then(function(a){d.storeStats(null,null,!0,null,null),c(null,a)},function(a){d.storeStats(null,null,!1,null,null),c(null,a)})},function(a,b){200===a.status?(d.storeStats(null,null,!0,null,null),b(null,a.data.token)):403===a.status?b(new Error("Access Denied"),null):(d.storeStats(null,null,!1,null,null),b(new Error("Unknown error: HTTP status "+a.status),null))},function(c,e){b({url:a.remote.url+"/api/data/dump/orders.json",method:"GET",headers:{"X-Authentication":c}}).then(function(a){d.storeStats(null,null,!0,null,null),e(null,a)},function(a){d.storeStats(null,null,!1,null,null),e(null,a)})},function(a,b){200===a.status?(d.storeStats(null,null,!0,null,null),b(null,a.data)):403===a.status?b(new Error("Access Denied"),null):(d.storeStats(null,null,!1,null,null),b(new Error("Unknown error: HTTP status "+a.status),null))},function(a,b){async.eachSeries(a,function(a,b){async.waterfall([function(b){f.findOne({uuid:a.uuid},b)},function(b,c){b?c(null,b):(g=!0,f.create(a,c))}],function(a){b(a)})},function(a){b(a)})}],function(a){if(a)return d.storeStats(null,null,!1,null,null),console.log("Sync orders failed with error: "+a.message),e(a);d.storeStats(null,null,!0,null,null),g&&(console.log("Sync orders completed - updating"),c.publish("sync-update")),e()})},pushLocal:function(a,b,c){require("lib-local/sync").addPendingUpdate(a,b,c)},pushPending:function(c){var e=require("lib-local/sync");async.waterfall([function(a){e.pendingUpdates(a)},function(c,f){d.storeStats(null,null,null,null,c.length),async.eachSeries(c,function(c,d){async.waterfall([function(d){b({method:"POST",url:a.push.url+"/api/tickets/push.json",data:c}).then(function(a){200===a.status||201===a.status?e.remove(c,c._id,d):400===a.status&&(console.log("Push update outdated"),e.remove(c,c._id,d))},function(a){400===a.status?(console.log("Push update outdated"),e.remove(c,c._id,d)):(console.log("Push update failed for ticket UUID "+c.ticket_uuid),d())})}],d)},f)}],function(a){if(a)return d.storeStats(null,null,!1,null,null),console.log("Push failed with error: "+a.message),c(a);d.storeStats(null,new Date,!0,null,null),c()})}}}]);