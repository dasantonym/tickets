/*! tickets cordova - v0.2.0 - 2017-06-27 */

angular.module("tickets.directives.ioloader",[]).directive("ioLoader",["App.Socket","PubSub",function(a,b){function c(a){var b=document.getElementById("socketScript"),c=document.createElement("script");c.setAttribute("id","socketScript"),c.setAttribute("type","text/javascript"),c.setAttribute("src",a),b&&c.src!==b.src?(document.getElementsByTagName("head")[0].removeChild(b),document.getElementsByTagName("head")[0].appendChild(c)):c&&!b&&document.getElementsByTagName("head")[0].appendChild(c)}function d(c){window.setTimeout(function(){if("function"==typeof io&&"string"==typeof c){var e=io("http://"+c+":7777");a.setSocket(e),a.setSocketCallback(function(a){console.log("Socket.io void callback with token:",a),b.publish("void-update",a)}),console.log("Socket.io connected")}else console.log("Socket.io not defined or empty IP, retrying"),window.setTimeout(function(){d(c)},0)},500)}return{restrict:"E",scope:{ipAddress:"@"},link:function(a,b,e){function f(){e.ipAddress&&(c("http://"+e.ipAddress+":7777/socket.io/socket.io.js"),d(e.ipAddress))}e.$observe("ipAddress",function(){f()})}}}]),angular.module("tickets.directives.utils",[]).directive("stringToNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return""+a}),d.$formatters.push(function(a){return parseFloat(a)})}}}),angular.module("tickets.services.socket",[]).factory("App.Socket",function(){return{socket:null,socketCallback:null,setSocket:function(a){var b=this;this.socket=a,this.socket.on("ticket.void",function(a){"function"==typeof b.socketCallback&&b.socketCallback(a)})},setSocketCallback:function(a){"function"==typeof a&&(this.socketCallback=a)},sendTicketVoid:function(a){this.socket&&this.socket.emit("ticket.void",a)}}}),function(){"use strict";angular.module("ticket-scanner",["ui.bootstrap","ngRoute","cgBusy","PubSub","tickets.directives.ioloader","tickets.controllers.tickets","tickets.services.settings","tickets.services.socket"]).config(["$routeProvider","$locationProvider","$logProvider",function(a,b,c){c.debugEnabled(!0);var d="./partials/";a.when("/",{templateUrl:d+"scan.html",controller:"Tickets.Scan"}),a.when("/settings",{templateUrl:d+"settings.html",controller:"Tickets.Settings"}),a.otherwise({redirectTo:"/"})}]).run(["$rootScope","$q","App.Settings","$location",function(a,b,c,d){a.goto=function(a){d.path(a)},a.remote={ip:c.remote.ip},a.$apply(),a.$on("$routeChangeStart",function(c,d,e){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null),a.pageDefer=b.defer(),a.pagePromise=a.pageDefer.promise}),a.$on("$routeChangeSuccess",function(b,c,d){a.pageDefer&&(a.pageDefer.resolve(),a.pageDefer=null)}),a.$on("$routeChangeError",function(b,c,d){a.pageDefer&&(a.pageDefer.reject(),a.pageDefer=null)})}])}(),function(){"use strict";angular.module("tickets.controllers.tickets",[]).controller("Tickets.Scan",["$scope","$q","$routeParams","App.Socket","App.Settings",function(a,b,c,d,e){a.scan=function(){cordova.plugins.barcodeScanner.scan(function(b){if(!b.cancelled){console.log(b.text,"http://"+e.remote.ip+":9999/api/tickets/void.json?"+b.text);var c=new XMLHttpRequest;c.open("GET","http://"+e.remote.ip+":9999/api/tickets/void.json?"+b.text,!0),c.setRequestHeader("Content-Type","application/json"),c.onreadystatechange=function(){if(4===c.readyState){if(200===c.status){var b=JSON.parse(c.responseText);b.success?(a.alerts=[{type:"success",msg:"Ticket is valid",ticket:b.ticket}],d.sendTicketVoid(b.ticket.token)):a.alerts=[{type:"danger",msg:b.error}]}else a.alerts=[{type:"danger",msg:"Server connection failed with status: "+c.status}],console.log({code:c.status,message:null},c.responseText);a.$apply()}},c.send()}},function(b){a.alerts=[{type:"danger",msg:"Scan failed: "+b}]})}}]).controller("Tickets.Settings",["$scope","$q","$routeParams","App.Settings","$rootScope",function(a,b,c,d,e){a.remote={ip:d.remote.ip},a.submit=function(){d.storeRemote(a.remote.ip),e.remote={ip:a.remote.ip},a.alerts=[{type:"success",msg:"Settings saved"}]}}]).controller("Tickets.List",["$scope","$q","$routeParams","App.Settings",function(a,b,c,d){a.tickets=[],a.filter={query:null},a.$watch("filter.query",function(b){async.each(a.tickets,function(c,d){[c.firstname,c.lastname,c.token].join(" ").indexOf(b)<0?a.tickets[a.tickets.indexOf(c)].hideEntry=!0:a.tickets[a.tickets.indexOf(c)].hideEntry=!1,d()})});var e=new XMLHttpRequest;e.open("GET","http://"+d.remote.ip+":9999/api/tickets/all.json",!0),e.setRequestHeader("Content-Type","application/json"),e.onreadystatechange=function(){4===e.readyState&&(200===e.status?(a.tickets=JSON.parse(e.responseText),a.$apply()):console.log({code:e.status,message:null},e.responseText))},e.send()}])}();var app={initialize:function(){this.bindEvents()},bindEvents:function(){document.addEventListener("deviceready",this.onDeviceReady,!1)},onDeviceReady:function(){app.receivedEvent("deviceready")},receivedEvent:function(a){console.log("Received Event: "+a)}};angular.module("tickets.services.settings",[]).factory("App.Settings",["$rootScope",function(a){return{remote:{ip:localStorage["remote.ip"]},storeRemote:function(b){this.remote.ip=b,localStorage["remote.ip"]=this.remote.ip,a.remote.ip=b}}}]);